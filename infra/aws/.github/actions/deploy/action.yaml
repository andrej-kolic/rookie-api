name: 'Deploy Rookie API'
description: 'Composite action for deploying Rookie API infrastructure or updating Lambda code'

inputs:
  action:
    description: 'Deployment action (infra, update, outputs)'
    required: true
    default: 'update'
  working-directory:
    description: 'Working directory for deployment'
    required: true
    default: 'infra/aws'

runs:
  using: 'composite'
  steps:
    - name: Validate action
      shell: bash
      run: |
        if [[ ! "${{ inputs.action }}" =~ ^(infra|update|outputs|generate-secret)$ ]]; then
          echo "::error::Invalid action. Must be one of: infra, update, outputs, generate-secret"
          exit 1
        fi

    - name: Execute deployment
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        chmod +x scripts/deploy.sh
        ./scripts/deploy.sh ${{ inputs.action }}

    - name: Display outputs
      if: inputs.action == 'infra' || inputs.action == 'update'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "::group::Stack Outputs"
        ./scripts/deploy.sh outputs
        echo "::endgroup::"
